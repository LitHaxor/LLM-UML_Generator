<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mermaid Chatbot</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      #chat-messages {
        height: calc(
          100vh - 170px
        ); /* Adjust based on your footer and header height */
      }
      .message-container {
        display: flex;
        justify-content: space-between;
      }
      .message-container.left .message {
        margin-right: auto;
      }
      .message-container.right .message {
        margin-left: auto;
      }
      .chat-application {
        margin: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .input-container {
        margin-bottom: 0; /* Remove the extra margin from the input */
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div
      class="bg-white shadow-lg rounded-lg mx-auto md:w-auto max-w-full h-screen chat-application"
    >
      <div
        class="bg-gray-700 text-white px-4 py-3 flex flex-col md:flex-row items-center justify-between"
      >
        <div class="font-bold text-lg mb-2 md:mb-0 md:mr-4">UML Benchmark</div>
        <div
          class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"
        >
          <div>
            <select
              id="uml-select"
              class="px-3 py-2 bg-gray-800 text-white rounded-md"
            >
              <option value="flowchart">Flow Chart</option>
              <option value="sequence">Sequence Diagram</option>
              <option value="class">Class Diagram</option>
              <option value="state">State Diagram</option>
              <option value="er">Entity Relationship Diagram</option>
            </select>
          </div>
        </div>
        <button
          id="clear-button"
          class="px-3 py-2 bg-blue-500 rounded-md mt-2 md:mt-0"
        >
          Clear Chat
        </button>
      </div>
      <div id="chat-messages" class="px-4 py-3 overflow-y-auto">
        <!-- Messages will be added dynamically here -->
      </div>
      <div class="input-container px-4 py-3 flex items-center bg-gray-200">
        <input
          type="text"
          id="message-input"
          class="border rounded py-2 px-3 flex-grow mr-2"
          placeholder="Type a message..."
        />
        <button
          id="send-button"
          class="bg-blue-500 text-white py-2 px-4 rounded"
        >
          Send
        </button>
      </div>
    </div>

    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

      mermaid.initialize({ startOnLoad: true });

      const clientId = generateClientId(); // Generate or retrieve the client ID
      const ws = new WebSocket(`ws://localhost:8000/ws/${clientId}`);
      const chatMessages = document.getElementById("chat-messages");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const clearButton = document.getElementById("clear-button");

      sendButton.addEventListener("click", sendMessage);
      clearButton.addEventListener("click", clearChat);

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const userName = data.user;
        const message = data.text;
        const original_prompt = data.original_prompt;
        const uml_type = data.uml_type;
        const model_name = userName;

        const parentDiv = document.createElement("div");
        parentDiv.classList.add(
          "message-container",
          "left",
          "px-3",
          "py-2",
          "rounded",
          "mb-2",
          "w-full",
          "bg-blue-400",
          "flex",
          "flex-col"
        );

        const userNameP = document.createElement("p");
        userNameP.classList.add("text-white", "text-right", "mb-1");
        userNameP.textContent = userName;

        const messageDiv = document.createElement("div");
        messageDiv.classList.add(
          "message",
          "text-white",
          "text-left",
          "bg-gray-200",
          "w-full"
        );
        messageDiv.textContent = message;

        // Create star rating div
        const starRatingDiv = document.createElement("div");
        starRatingDiv.classList.add(
          "star-rating",
          "flex",
          "justify-end",
          "mt-2"
        );

        // Create stars
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement("span");
          star.classList.add("star", "text-gray-400", "cursor-pointer");
          star.textContent = "â˜…";
          star.dataset.rating = i;

          // Add click event to each star
          star.addEventListener("click", () => {
            const rating = parseInt(star.dataset.rating);
            highlightStars(starRatingDiv, rating);
            sendRating(userName, message, rating, model_name, uml_type, original_prompt);
          });

          starRatingDiv.appendChild(star);
        }

        parentDiv.appendChild(userNameP);
        parentDiv.appendChild(messageDiv);
        parentDiv.appendChild(starRatingDiv);

        chatMessages.appendChild(parentDiv);

        // Initialize Mermaid diagrams within the new message
        mermaid.init(undefined, messageDiv);

        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      // Function to highlight stars based on rating
      function highlightStars(starRatingDiv, rating) {
        const stars = starRatingDiv.querySelectorAll(".star");
        stars.forEach((star) => {
          if (parseInt(star.dataset.rating) <= rating) {
            star.classList.add("text-yellow-500");
            star.classList.remove("text-gray-400");
          } else {
            star.classList.add("text-gray-400");
            star.classList.remove("text-yellow-500");
          }
        });
      }

      // Function to send rating via POST request
      function sendRating(user, message, rating, model_name, uml_type, original_prompt) {
        fetch('/api/rating', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model_name,
            text_data: message, 
            rating: rating,
            client_id: clientId,
            uml_type,
            original_prompt,
          })
        }).then((response) => {
          if (response.ok) {
            console.log('Rating sent successfully');
          } else {
            console.error('Failed to send rating');
          }
        });
      }

      function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
          ws.send(
            JSON.stringify({
              text: message,
              uml_type:
                document.getElementById("uml-select")?.value ?? "flowchart",
            })
          );
          const userMessage = document.createElement("div");
          userMessage.classList.add(
            "message-container",
            "right",
            "px-3",
            "py-2",
            "rounded",
            "mb-2",
            "w-full",
            "bg-gray-200",
            "text-left"
          );

          const userNameP = document.createElement("p");
          userNameP.classList.add("text-right");
          userNameP.textContent = "You";

          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message");
          messageDiv.textContent = message;

          userMessage.appendChild(userNameP);
          userMessage.appendChild(messageDiv);

          chatMessages.appendChild(userMessage);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          messageInput.value = "";
        }
      }

      function clearChat() {
        chatMessages.innerHTML = "";
      }

      ws.onclose = () => {
        const messageElement = document.createElement("div");
        messageElement.classList.add("px-3", "py-2", "rounded", "mb-2");
        messageElement.textContent = "Connection closed";
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      function generateClientId() {
        // Simple client ID generation (you can replace this with a more robust method)
        return "client-" + Math.random().toString(36).substr(2, 9);
      }
    </script>
  </body>
</html>
